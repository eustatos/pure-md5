# Задача 5: Оптимизация циклов и операций

## Контекст
Критические участки кода в MD5 реализации могут быть оптимизированы для улучшения производительности. Основные кандидаты:
1. Циклы в `md51.ts`
2. Битовые операции в `add32.ts`
3. Операции со строками в `md5blk.ts`

## Цель
Улучшить производительность MD5 реализации на 10-20% через оптимизацию циклов и операций.

## Требуемые действия

### Шаг 1: Анализ текущей производительности
1. Создать простой бенчмарк для измерения производительности
2. Измерить текущую скорость MD5 хеширования
3. Определить bottleneck'ы через профилирование

**Пример бенчмарка:**
```typescript
// benchmark.ts
import { md5 } from './index';

const start = performance.now();
for (let i = 0; i < 10000; i++) {
  md5('test string ' + i);
}
const end = performance.now();
console.log(`Time: ${end - start}ms`);
```

### Шаг 2: Оптимизация md51.ts
1. Открыть `src/md51.ts`
2. Оптимизировать циклы:
   - Использовать `while` вместо `for` где это уместно
   - Предвычислять константы
   - Уменьшить количество операций в цикле
3. Оптимизировать работу со строками:
   - Использовать `charCodeAt` более эффективно
   - Рассмотреть использование `Uint8Array` для бинарных данных

### Шаг 3: Оптимизация add32.ts
1. Открыть `src/add32.ts`
2. Сравнить производительность разных реализаций:
   ```typescript
   // Вариант 1: текущий
   return (x + y) & 0xffffffff;
   
   // Вариант 2: inline из index.ts
   let lsw = (x & 0xffff) + (y & 0xffff);
   let msw = (x >> 16) + (y >> 16) + (lsw >> 16);
   return (msw << 16) | (lsw & 0xffff);
   ```
3. Выбрать наиболее производительную реализацию
4. Добавить комментарии о выборе реализации

### Шаг 4: Оптимизация md5cycle.ts
1. Открыть `src/md5cycle.ts`
2. Оптимизировать вызовы функций:
   - Рассмотреть инлайнинг small функций
   - Уменьшить количество `.bind()` вызовов
   - Предвычислять константы
3. Оптимизировать доступ к массивам

### Шаг 5: Оптимизация работы с памятью
1. Рассмотреть использование typed arrays вместо обычных массивов
2. Уменьшить аллокации памяти в циклах
3. Переиспользовать буферы где это возможно

### Шаг 6: Проверить корректность после оптимизаций
1. Запустить все тесты: `npm test`
2. Проверить что оптимизации не ломают логику
3. Запустить бенчмарк для измерения улучшений

### Шаг 7: Добавить перфоманс тесты
1. Создать тесты производительности в `src/*.perf.test.ts`
2. Добавить baseline измерения
3. Установить пороги для регрессий

## Ожидаемый результат
- Улучшение производительности на 10-20%
- Сохранение корректности MD5 алгоритма
- Все тесты проходят
- Добавлены перфоманс тесты

## Проверка прогресса
- [ ] Создан бенчмарк для измерения производительности
- [ ] Оптимизированы циклы в md51.ts
- [ ] Оптимизирована реализация add32.ts
- [ ] Оптимизирован md5cycle.ts
- [ ] Проверена работа с памятью
- [ ] Все тесты проходят
- [ ] Измерено улучшение производительности
- [ ] Добавлены перфоманс тесты

## Примечания
1. Оптимизации не должны ломать корректность алгоритма
2. Сохранять читаемость кода
3. Документировать причины выбора оптимизаций

## Метрики
1. Время хеширования 10к строк (до/после)
2. Размер бандла (не должен увеличиться)
3. Потребление памяти

## Следующий шаг
После оптимизации производительности перейти к Задаче 6: Настройка Webpack для минимального бандла.